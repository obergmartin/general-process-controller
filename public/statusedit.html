<HTML>
<HEAD>
    <TITLE>Status Config</TITLE>
    <script src="app.js"></script>
    <LINK rel='stylesheet' type='text/css' href='style.css'>
</HEAD>

<BODY BGCOLOR="#FFFFFF">

<script src="./Sortable.min.js"></script>

<h2>Status Config</h2>
<div id='navigation'></div>
<script type="text/javascript" src="links.js"></script>

<script type="text/javascript" src="recent.json"></script>

<div id='title_area' class='block_container'>
<b>Title</b>
</div><br>

<div id='var_area' class='block_container'>
<b>Variables</b>
</div><br>

<div id='tail_area' class='block_container'>
<input type='submit' id='update_button' style="float: right;">
</div>


<script>
  //
var sort_opts = {
  filter: '.js-remove',
  onFilter: function (evt) {
    var el = editableList.closest(evt.item); 
    el && el.parentNode.removeChild(el);
  }
};

var httpRequest = new XMLHttpRequest();
httpRequest.open('GET', 'init.json', false);
httpRequest.send();
var init = JSON.parse(httpRequest.responseText).init;

httpRequest.open('GET', 'status.json', false);
httpRequest.send();
var stat = JSON.parse(httpRequest.responseText).stat;
var title_text = JSON.parse(httpRequest.responseText).title;
console.log(stat);

ws.onopen = function() {
  ws.send(JSON.stringify({'getFile': 'init.json'}));
  ws.send(JSON.stringify({'getFile': 'status.json'}));
  //showPage();
};

ws.onmessage = function (event) {
  var mess = JSON.parse(event.data);
  console.log(mess);
  if (mess.hasOwnProperty('init')) {
    var data = mess['init'];
    console.log(data);
    init = data;
    makePage();
  }
  else if (mess.hasOwnProperty('stat')) {
    stat = mess['stat'];
    console.log(stat);
    populatePage();
  }
  else if (mess.hasOwnProperty('title')) {
    title = mess['title'];
    console.log(title);
    //populatePage();
  }

};


var title_area = document.getElementById("title_area");
title_area.align = 'left';

var title_input = document.createElement('input');
title_input.type = 'text';
title_input.value = title_text;
title_area.appendChild(title_input);

function makeVarRow(t1, t2, t3) {
  var new_row = document.createElement('tr');
  
  var content = document.createElement('p');
  content.innerText = t2;
  var new_cell = document.createElement('td');
  new_cell.appendChild(content);
  new_row.appendChild(new_cell);
  
  content = document.createElement('input');
  content.type = 'text';
  content.value = t1;
  new_cell = document.createElement('td');
  new_cell.appendChild(content);
  new_row.appendChild(new_cell);
  
  content = document.createElement('input');
  content.type = 'text';
  content.value = t3;
  new_cell = document.createElement('td');
  new_cell.appendChild(content);
  new_row.appendChild(new_cell);
  
  return new_row;
}

var table;
var sortabelInputVals;
//make table
var table = document.createElement('table');
var sortableInputVals = Sortable.create(table, sort_opts);
  

function makePage() {
  var header = table.createTHead();
  header.appendChild( makeTextRow(['Name', 'Label', 'Value']) );
}

function populatePage() {

  for (i = 0; i < init.InputVals.length; i++) {
  	var cur_name = init.InputVals[i].Name;
  	//var cur_value = init.InputVals[i].Value;
  	var cur_label = (stat.hasOwnProperty(cur_name)) 
  	  ? stat[cur_name].Label 
  	  : '';
    var cur_value = (stat.hasOwnProperty(cur_name)) 
      ? JSON.stringify(stat[cur_name].Value) 
      : '';
    cur_value = (cur_value.length <= 2) 
      ? '' 
      : cur_value; // text is blank if "" returned above
    
    var new_row = makeVarRow(cur_label, cur_name, cur_value);
    table.appendChild(new_row);

  }
  
  for (i = 0; i < init.Evals.length; i++) {
  	var cur_name = init.Evals[i].Name;
  	//var cur_value = init.InputVals[i].Value;
  	var cur_label = (stat.hasOwnProperty(cur_name)) 
  	  ? stat[cur_name].Label 
  	  : '';
    var cur_value = (stat.hasOwnProperty(cur_name)) 
      ? JSON.stringify(stat[cur_name].Value) 
      : '';
    cur_value = (cur_value.length <= 2) 
      ? '' 
      : cur_value; // text is blank if "" returned above
    
    new_row = makeVarRow(cur_label, cur_name, cur_value);
    table.appendChild(new_row);

  }
  var_area.appendChild(table);
  
  
  var button = document.getElementById('update_button');
  update_button.value = 'Update!';
  update_button.onclick = function(){ 
    update_page();
  };
}
  

function update_page() {
  var dat = {};
  titleText = title_input.value;
  
  for (var i = 1; i < table.rows.length; i++) {
    var r = {};
    r.Name =  table.rows[i].cells[0].children[0].innerText;
    r.Label = table.rows[i].cells[1].children[0].value;
    r.Value = table.rows[i].cells[2].children[0].value;
    
    var val;
    if (r.Label !== "") {
      if (r.Value.length > 0) {
        eval('val ='+ r.Value);
      } else {
        val = '';
      }
      dat[r.Name] = {"Label": r.Label, "Value": val};
    }
    console.log('table,', dat);
  }
  
  //console.log(dat);
  //var dataSend = JSON.stringify(dat, null, ' ');
  //console.log(dataSend);
  
  
  //xhr = new XMLHttpRequest();
  //var url = "/statusedit.html";
  //xhr.open("POST", url);//, true);
  //xhr.setRequestHeader("Content-type", "application/json;charset=UTF-8");
  //xhr.onreadystatechange = function () { 
  //  if (xhr.readyState == 4 && xhr.status == 200) {
  //    //var json = JSON.parse(xhr.responseText);
  //    console.log(xhr.responseText);
  //    alert(xhr.responseText);
  //  }
  //};
  var dataSend = JSON.stringify({"stat": dat, "title": titleText}, null, ' ');
  //console.log(dataSend);
  //xhr.send(dataSend);
  //window.location.href = "statusedit.html";
  console.log(dat);
  var toSend = JSON.stringify({
    saveData: {
      File: "status.json",
      Data: {
        stat: dat,
        title: titleText
      }
    }
  }, null, ' ');
  console.log(toSend);
  ws.send(toSend);
}

</script>

<a href='status.html'>return to status</a>

</BODY>
</HTML>



